apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

helmCharts:
- name: nutanix-csi-storage
  repo: https://nutanix.github.io/helm/
  version: 2.6.6
  releaseName: nutanix-csi-storage
  namespace: kube-system
  valuesFile: generate-values-csi-storage

patches:
  - target:
      version: v1
      kind: Secret
      name: ntnx-secret
    patch: |-
      - op: replace
        path: /data/key
        value: |
          {{ printf "%s:%s:%s:%s" .Credentials.NUTANIX_PE_ENDPOINT .Credentials.NUTANIX_PORT .Credentials.NUTANIX_PE_USERNAME .Credentials.NUTANIX_PE_PASSWORD | b64enc }}
  - target:
      group: apps
      version: v1
      kind: DaemonSet
      name: nutanix-csi-node
    patch: |-
      - op: add
        path: /spec/template/metadata/annotations
        value:
          "kubeone.k8c.io/cabundle-hash": "{{ .Config.CABundle | sha256sum }}"
          "kubeone.k8c.io/credentials-hash": "{{ .CredentialsCCMHash }}"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: |-
          {{ .InternalImages.Get "NutanixCSIRegistrar" }}
      - op: replace
        path: /spec/template/spec/containers/1/image
        value: |-
          {{ .InternalImages.Get "NutanixCSI" }}
      - op: replace
        path: /spec/template/spec/containers/2/image
        value: |-
          {{ .InternalImages.Get "NutanixCSILivenessProbe" }}
  - target:
      group: apps
      version: v1
      kind: Deployment
      name: nutanix-csi-controller
    patch: |-
      - op: add
        path: /spec/template/metadata/annotations
        value:
          "kubeone.k8c.io/cabundle-hash": "{{ .Config.CABundle | sha256sum }}"
          "kubeone.k8c.io/credentials-hash": "{{ .CredentialsCCMHash }}"
      - op: replace
        path: /spec/template/spec/containers/0/image
        value: |-
          {{ .InternalImages.Get "NutanixCSIProvisioner" }}
      - op: replace
        path: /spec/template/spec/containers/1/image
        value: |-
          {{ .InternalImages.Get "NutanixCSIResizer" }}
      - op: replace
        path: /spec/template/spec/containers/2/image
        value: |-
          {{ .InternalImages.Get "NutanixCSISnapshotter" }}
      - op: replace
        path: /spec/template/spec/containers/3/image
        value: |-
          {{ .InternalImages.Get "NutanixCSI" }}
      - op: replace
        path: /spec/template/spec/containers/4/image
        value: |-
          {{ .InternalImages.Get "NutanixCSILivenessProbe" }}
