apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

helmCharts:
- name: nutanix-csi-storage
  repo: https://nutanix.github.io/helm-releases/
  version: 3.3.4
  releaseName: nutanix-csi-storage
  namespace: kube-system
  valuesFile: generate-values-csi-storage

patches:
  - patch: |-
      apiVersion: storage.k8s.io/v1
      kind: CSIDriver
      metadata:
        name: csi.nutanix.com
      $patch: delete

  - patch: |-
      apiVersion: batch/v1
      kind: Job
      metadata:
        name: nutanix-csi-storage-precheck-job
      spec:
        template:
          spec:
            containers:
              - name: ntnx-csi-precheck
                image: '{{ .InternalImages.Get "NutanixCSIPrecheck" }}'

  - patch: |-
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: nutanix-csi-node
        namespace: kube-system
      spec:
        template:
          metadata:
            annotations:
              kubeone.k8c.io/cabundle-hash: '{{ CABundle | sha256sum }}'
              kubeone.k8c.io/credentials-hash: '{{ .CredentialsCCMHash }}'
          spec:
            containers:
              - name: driver-registrar
                image: '{{ .InternalImages.Get "NutanixCSIRegistrar" }}'
              - name: nutanix-csi-node
                image: '{{ .InternalImages.Get "NutanixCSI" }}'
              - name: liveness-probe
                image: '{{ .InternalImages.Get "NutanixCSILivenessProbe" }}'

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: nutanix-csi-controller
        namespace: kube-system
      spec:
        template:
          metadata:
            annotations:
              kubeone.k8c.io/cabundle-hash: '{{ CABundle | sha256sum }}'
              kubeone.k8c.io/credentials-hash: '{{ .CredentialsCCMHash }}'
          spec:
            containers:
              - name: csi-provisioner
                image: '{{ .InternalImages.Get "NutanixCSIProvisioner" }}'
              - name: csi-attacher
                image: '{{ .InternalImages.Get "NutanixCSIAttacher" }}'
              - name: csi-resizer
                image: '{{ .InternalImages.Get "NutanixCSIResizer" }}'
              - name: csi-snapshotter
                image: '{{ .InternalImages.Get "NutanixCSISnapshotter" }}'
              - name: nutanix-csi-plugin
                image: '{{ .InternalImages.Get "NutanixCSI" }}'
              - name: liveness-probe
                image: '{{ .InternalImages.Get "NutanixCSILivenessProbe" }}'
              - name: csi-external-health-monitor-controller
                image: '{{ .InternalImages.Get "NutanixCSIExternalHealthMonitor" }}'
