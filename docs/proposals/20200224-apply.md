# KubeOne Reconciliation Process (`kubeone apply`)

**Author:** Marko MudriniÄ‡ ([@xmudrii](https://github.com/xmudrii))
**Status:** **Draft** | Review | Final
**Created:** 2020-02-24
**Last updated:** 2020-02-24

## Abstract

KubeOne supports installing/provisioning and upgrading clusters, with repairs being
planned as well. Currently, all features are implemented as dedicated subcommands,
for example, `install` and `upgrade`. Instead of having a subcommand for each feature,
we want to implement the reconciliation process under the `apply` subcommand. `apply`
would analyze the provided cluster configuration file (the expected state) and the cluster
actual state, and based on the difference take the appropriate steps.
The appropriate steps can be operations such as install, upgrade, repair cluster,
apply missing manifest, create or rotate the worker nodes...

## Goals

* Implement the `apply` subcommand
  * Implement probes to detect the state of the cluster
  * Implement the logic to take the appropriate steps depending on
  the results returned by probes (e.g. install or upgrade the cluster)

## Non-goals

* Implement the repair process
* Automatically recover from cases when there is no healthy node or
  quorum is not satisfied
* Deprecate existing subcommands (`install` and `upgrade`)

## Glossary

* _etcd ring_: a group of etcd instances forming a single etcd cluster.
* _etcd member_: a known peer instance (running on the control-plane nodes) of
  etcd inside the etcd ring.

## Implementation

The reconciliation process is going to be invoked by the `kubeone apply` command.
The command takes the KubeOne cluster configuration manifest, which represents the
expected state, and optionally Terraform state and set of flags and options.

Example: `kubeone apply config.yaml -t tfstate.json`

Once invoked, the command takes the following steps:
* parse the provided cluster configuration to determine the expected state
* run probes to determine the actual state of the cluster
* run a specific set of actions to turn the actual state into the expected state (reconcile)
* re-run probes to ensure that actual and expected states of the cluster match

### Probes

Probes are used to determine the actual state of the cluster. They are implemented
as scripts to be executed over SSH or as Kubernetes API requests. For example, a
probe can check is `kubelet` running on a node or does all required pods exist.

The following probes **must** be implemented:

* is cluster provisioned
* is specific node provisioned, ready, and responsive
* is the actual Kubernetes version matching the desired version
* are critical control plane pods running and healthy
* is `etcd` ring healthy and in the expected state (all control plane nodes joined)
* is the actual cluster configuration matching the expected cluster configuration
* are worker nodes running and responsive

Some of the mentioned checks are already implemented in some form in `upgrade` and
`status` subcommands.

### Reconciling The Cluster

Depending on the actual state of the cluster determined by probes, KubeOne will try
to modify the cluster to match the expected state.

Some actions will be taken automatically, however, it is not planned to fully-automate
all actions. For example, if `kubeone apply` determines that a node needs to be repaired,
it would be up to the operator to create a new VM, update the cluster configuration
(or Terraform state) and then run `kubeone apply` again.

The following flowchart shows what actions are supported and how KubeOne makes the decision
based on the results returned by probes.

![kubeone apply flowchart](./apply-flowchart.svg)

This proposal doesn't cover cases when there is no healthy node and/or the quorum is not satisfied.
In such cases, data integrity can't be guaranteed, so the recommended steps are to reinitialize
the cluster and restore data from the backup.

## Tasks & Efforts

* Implement probes as described in the Probes section
* Implement the cluster reconciliation process
* Write E2E tests for the `kubeone apply` command
* Write and/or update documentation
